---
title: "Evaluating temperature-dependence of growth allometry"
author: "Max Lindmark, Jan Ohlberger, Anna Gårdmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
Fit log-linear models to growth in line with MTE but with random effects, mass-temperature interactions and within species data.

```{r lib, message=FALSE}
# Load libraries, install if needed
library(tidyverse)
library(brms)
library(RCurl)
library(tidybayes)
library(bayesplot)
library(RColorBrewer)
library(viridis)
library(tidylog)
library(modelr)
library(patchwork)
library(sjPlot)
library(sjmisc)
library(sjlabelled)

options(mc.cores = parallel::detectCores()) 

# To load entire cache in interactive r session, do: qwraps2::lazyload_cache_dir(path = "R/allometric_growth_model/html")
```

## Read and explore data
* decide what to do with data beyond peak for a size group...

```{r read and exlplore data, warning=FALSE, message=FALSE}
# Read in your data file
dat <- 
  read.csv(text = getURL("https://raw.githubusercontent.com/maxlindmark/scaling/master/data/growth_analysis.csv"))

str(dat)

# Filter data points at below optimum temperatures
#dat <- dat %>% filter(above_peak_temp == "N")
colnames(dat)

ggplot(dat, aes(temp_c, mass_g*y, color = factor(mass_g))) + 
  geom_point() +
  facet_wrap(~species_ab, scales = "free") +
  theme_classic() +
  stat_smooth(se = FALSE) + 
  guides(color = FALSE) + 
  scale_color_viridis(discrete = TRUE)

ggplot(dat, aes(temp_c, y, group = factor(mass_g))) + 
  facet_wrap(~species_ab, scales = "free") +
  theme_classic() +
  stat_smooth(se = FALSE, color = "gray") + 
  geom_point(data = dat, aes(temp_c, y, color = above_peak_temp))

# Model
dat <- dat %>%
  group_by(species_ab) %>%
  filter(y > 0) %>% 
  mutate(log_y = log(y),
         log_mass_intra = log_mass - mean(log_mass),
         temp_arr_intra = temp_arr - mean(temp_arr)) %>% 
  ungroup()
```

## Fit models
* get priors

```{r fit models, cache=TRUE, message=FALSE}
m_gauss <- brm(
  log_y ~ log_mass_intra*temp_arr_intra + log_mass + temp_arr + (1 + log_mass_intra*temp_arr_intra | species_ab),
  data = dat, family = gaussian(), save_pars = save_pars(all = TRUE), control = list(adapt_delta = 0.95),
  iter = 4000, cores = 4, chains = 4)

m_student <- brm(
  log_y ~ log_mass_intra*temp_arr_intra + log_mass + temp_arr + (1 + log_mass_intra*temp_arr_intra | species_ab),
  data = dat, family = student(), save_pars = save_pars(all = TRUE), control = list(adapt_delta = 0.95),
  iter = 4000, cores = 4, chains = 4)

m_skew <- brm(
  log_y ~ log_mass_intra*temp_arr_intra + log_mass + temp_arr + (1 + log_mass_intra*temp_arr_intra | species_ab),
  data = dat, family = skew_normal(), save_pars = save_pars(all = TRUE), control = list(adapt_delta = 0.95),
  iter = 4000, cores = 4, chains = 4)

loo_gauss <- loo(m_gauss, moment_match = TRUE)
loo_student <- loo(m_student, moment_match = TRUE)
loo_skew <- loo(m_skew, moment_match = TRUE)

loo_compare(loo_gauss, loo_student, loo_skew)
```

## Make plots

```{r plot, message=FALSE}
# Summary
# https://cran.r-project.org/web/packages/sjPlot/vignettes/tab_model_estimates.html
tab_model(m_skew)

# Plot
conditional_effects(m_skew)

get_variables(m_skew)

pred_df <- bind_rows(dat %>% data_grid(log_mass_intra = seq_range(log_mass_intra, n = 101)),
                     dat %>% data_grid(log_mass_intra = seq_range(log_mass_intra, n = 101))) 

ggplot(dat, aes(temp_c, temp_arr_intra)) +
  geom_point() +
  stat_smooth(method = "lm") + 
  geom_hline(yintercept = c(-0.55, 0.49), color = "tomato") +
  geom_vline(xintercept = c(3.5, 31), color = "tomato")

p1 <- pred_df %>% mutate(temp_arr = rep(mean(dat$temp_arr), 101*2), #summary(dat$temp_arr)
                   log_mass = rep(mean(dat$log_mass), 101*2),
                   temp_arr_intra = rep(c(-0.55, 0.49), each = 101)) %>% # summary(dat$temp_arr_intra)
  add_epred_draws(m_skew, re_formula = NA) %>%
  ggplot(., aes(x = log_mass_intra, y = .epred, 
                color = factor(temp_arr_intra), fill = factor(temp_arr_intra))) +
  stat_lineribbon(.width = c(.80), alpha = 1/4) +
  stat_lineribbon(.width = 0, alpha = 0.7) +
  scale_color_brewer(palette = "Set1", name = "") +
  scale_fill_brewer(palette = "Set1", name = "Temperature") + 
  theme_classic() +
  guides(color = FALSE) + 
  labs(x = expression(paste("log(", mass[intra], ")"))) + 
  theme(aspect.ratio = 1,
        legend.position = c(0.3, 0.2))

# Plot
# m_skew %>%
#   gather_draws(b_log_mass_intra, b_temp_arr_intra, 
#                b_log_mass, b_temp_arr, `b_log_mass_intra:temp_arr_intra`,
#                sd_species_ab__Intercept, sd_species_ab__log_mass_intra,
#                sd_species_ab__temp_arr_intra, sigma) %>%
#   ggplot(aes(x = .variable, y = .value)) +
#   stat_halfeye() + 
#   theme_classic() + 
#   coord_flip() +
#   geom_vline(xintercept = 0, linetype = "dashed") +
#   scale_fill_manual(values = c("gray80", "tomato"))

p2 <- m_skew %>%
  spread_draws(`b_log_mass_intra:temp_arr_intra`) %>%
  ggplot(aes(x = `b_log_mass_intra:temp_arr_intra`, fill = stat(x < 0))) +
  stat_halfeye(.width = c(0.75, 0.95)) + 
  theme_classic() + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_fill_manual(values = c("gray80", "tomato")) +
  labs(x = "Mass×Temp. interaction") +
  theme(aspect.ratio = 1,
        legend.position = c(0.8, 0.5))

(p1 | p2) + plot_annotation(tag_levels = "A")
ggsave("figures/Fig1.png", width = 6.5, height = 6.5, dpi = 600)


p3 <- m_skew %>%
  spread_draws(`b_log_mass_intra:temp_arr_intra`,
               r_species_ab[species_ab, `log_mass_intra:temp_arr_intra`]) %>%
  filter(`\`log_mass_intra:temp_arr_intra\`` == "log_mass_intra:temp_arr_intra") %>% 
  mutate(interaction_mean = `b_log_mass_intra:temp_arr_intra` + r_species_ab) %>%
  ggplot(aes(y = species_ab, x = interaction_mean, fill = stat(x < 0))) +
  stat_halfeye() + 
  theme_classic(base_size = 12) + 
  coord_cartesian(xlim = c(-0.2, 0.25)) + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_fill_manual(values = c("gray80", "tomato")) + 
  theme(legend.position = "bottom", 
        axis.text.y = element_text(face = "italic")) + 
  labs(y = "Species", x = "Mass×Temperature interaction") +
  NULL

p3
ggsave("figures/Fig2.png", width = 4, height = 8, dpi = 600)


# Model validation
posterior <- as.array(m_skew)
dimnames(posterior)

mcmc_trace(
  posterior, 
  pars = c("b_log_mass_intra", "b_temp_arr_intra", 
           "b_log_mass", "b_temp_arr", "b_log_mass_intra:temp_arr_intra",
           "sd_species_ab__Intercept", "sd_species_ab__log_mass_intra",
           "sd_species_ab__temp_arr_intra", "sigma"),
  facet_args = list(ncol = 3, strip.position = "left")) + 
  geom_line(alpha = .5) +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 3),
        legend.position = c(0.6, 0.05),
        legend.direction = "horizontal") + 
  scale_color_viridis(discrete = TRUE, direction = -1) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom") + 
  theme_classic() +
  NULL

ggsave("figures/FigS1.png", width = 6.5, height = 6.5, dpi = 600)

# Posterior predictive
pp_check(m_skew) + 
  theme(text = element_text(size = 12),
        legend.position = c(0.15, 0.95),
        legend.background = element_rect(fill = NA)) + 
  scale_color_brewer(palette = "Dark2") +
  labs(color = "") +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.2, 0.9)) + 
  NULL

ggsave("figures/FigS2.png", width = 4, height = 4, dpi = 600)
```



